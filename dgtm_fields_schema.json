{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://example.com/schemas/dgtm-v4.0-robust.json",
  "title": "DGTM Schema v4.0 - Análise Semântica Contextual Fortalecida",
  "description": "Schema aprimorado para análise semântica profunda com validação contextual expandida, herança semântica e matriz de compatibilidade",
  "version": "4.0.0",
  "schema_version": "4.0.0",
  "type": "object",
  
  "coherence_rules": {
    "description": "Regras de consistência entre campos com validação contextual expandida",
    "rules": [
      {
        "if": {
          "classe_gramatical": ["interjeição", "conectivo"]
        },
        "then": {
          "emotion": {"required": false},
          "intention": {"required": false}
        }
      },
      {
        "if": {"emotion.value": "neutralidade"},
        "then": {"intensity.value": {"maximum": 0.3}},
        "message": "Intensidade não pode ser alta quando a emoção é 'neutralidade'"
      },
      {
        "if": {"context.formality_level": {"minimum": 4}},
        "then": {"tone.value": {"not": ["informal", "coloquial", "humorístico"]}},
        "message": "Tom informal incoerente com nível de formalidade elevado"
      },
      {
        "if": {
          "emotion.value": "alegria",
          "intensity.value": {"maximum": 0.0}
        },
        "then": {
          "errorMessage": "Intensidade deve ser maior que zero para emoção 'alegria'."
        }
      },
      {
        "if": {
          "intention.value": "atacar",
          "tone.value": {"not": ["irônico", "sarcástico", "agressivo"]}
        },
        "then": {
          "message": "Tom esperado para intenção 'atacar' é irônico, sarcástico ou agressivo."
        }
      },
      {
        "if": {"context.discourse_type": "jurídico"},
        "then": {
          "context.formality_level": {"minimum": 4},
          "tone.value": {"not": ["informal", "humorístico", "coloquial"]}
        },
        "message": "Discursos jurídicos requerem formalidade"
      },
      {
        "if": {
          "classe_gramatical": ["interjeição"],
          "emotion.value": "expectativa"
        },
        "then": {
          "intensity.value": {"minimum": 0.1},
          "message": "Interjeições de expectativa requerem intensidade mínima"
        }
      },
      {
        "if": {
          "intention.value": "corrigir",
          "context.discourse_type": "acadêmico"
        },
        "then": {
          "tone.value": {"not": ["agressivo", "irônico", "sarcástico"]},
          "message": "Correções em contexto acadêmico devem ter tom neutro/respeitoso"
        }
      }
    ]
  },
  
  "$defs": {
    "descriptive_value": {
      "type": "object",
      "properties": {
        "value": {
          "type": "string",
          "description": "Valor descritivo da propriedade semântica"
        },
        "where": {
          "type": "string",
          "description": "Local ou contexto onde o valor ocorre",
          "examples": ["discurso formal", "diálogo informal"]
        },
        "how": {
          "type": "string",
          "description": "Modo de ocorrência ou expressão",
          "examples": ["ênfase", "tom de voz", "gesto"]
        },
        "context": {
          "type": "string",
          "description": "Contexto interpretativo ou circunstância",
          "examples": ["contexto cultural", "situação hipotética"]
        },
        "sense": {
          "type": "string",
          "description": "Sentido ou significado associado",
          "examples": ["literal", "irônico", "figurado"]
        }
      },
      "required": ["value"]
    },
    
    "common_properties": {
      "type": "object",
      "properties": {
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Confiança na atribuição da propriedade"
        },
        "last_updated": {
          "type": "string",
          "format": "date-time",
          "description": "Última atualização da propriedade"
        },
        "source": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "type": {
                "type": "string",
                "enum": ["corpus", "especialista", "estatística", "dicionário"]
              },
              "reference": {"type": "string"},
              "confidence": {
                "type": "number",
                "minimum": 0,
                "maximum": 1
              }
            },
            "required": ["type", "confidence"]
          },
          "description": "Fontes que suportam a atribuição com metadados"
        }
      },
      "required": ["confidence", "last_updated"]
    },
    
    "dynamic_enum": {
      "type": "object",
      "properties": {
        "base_values": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Valores iniciais base para o enum dinâmico"
        },
        "extensible": {
          "type": "boolean",
          "description": "Indica se novos valores podem ser adicionados dinamicamente"
        },
        "new_values_log": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "value": {"type": "string"},
              "first_observed": {"type": "string", "format": "date-time"},
              "usage_count": {"type": "integer", "minimum": 1},
              "evidence": {
                "type": "array",
                "items": {"type": "string"}
              }
            },
            "required": ["value", "first_observed", "usage_count"]
          },
          "description": "Registro dos novos valores observados e sua frequência"
        }
      },
      "required": ["base_values", "extensible"]
    },
    
    "value_stats": {
      "type": ["object", "null"],
      "properties": {
        "usage_count": {
          "type": "integer",
          "description": "Número de vezes que o valor foi observado"
        },
        "last_seen": {
          "type": "string",
          "format": "date-time",
          "description": "Data da última observação do valor"
        },
        "source": {
          "type": "string",
          "description": "Fonte da última observação"
        },
        "semantic_drift": {
          "type": "object",
          "properties": {
            "baseline_value": {"type": "string"},
            "drift_score": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            },
            "last_calibration": {"type": "string", "format": "date-time"}
          },
          "description": "Monitoramento de desvio semântico ao longo do tempo"
        }
      }
    },
    
    "curation_info": {
      "type": ["object", "null"],
      "properties": {
        "validado_por": {
          "type": "string",
          "description": "Nome ou identificador do validador"
        },
        "validado_em": {
          "type": "string",
          "format": "date-time",
          "description": "Data da validação"
        },
        "confiabilidade": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Índice de confiabilidade da validação"
        },
        "comentarios": {
          "type": "string",
          "description": "Observações do curador"
        }
      }
    },
    
    "compatibility_matrix": {
      "type": "object",
      "properties": {
        "emotion_intention": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "emotion": {"type": "string"},
              "allowed_intentions": {"type": "array", "items": {"type": "string"}},
              "prohibited_tone": {"type": "array", "items": {"type": "string"}}
            },
            "required": ["emotion", "allowed_intentions"]
          },
          "description": "Relações permitidas entre emoções e intenções"
        }
      },
      "default": {
        "emotion_intention": [
          {"emotion": "neutralidade", "allowed_intentions": ["explicar", "informar", "orientar"], "prohibited_tone": ["agressivo", "sarcástico"]},
          {"emotion": "alegria", "allowed_intentions": ["celebrar", "felicitar", "cumprimentar"], "prohibited_tone": ["neutro", "triste"]},
          {"emotion": "raiva", "allowed_intentions": ["criticar", "protestar", "atacar"], "prohibited_tone": ["respeitoso", "neutro"]},
          {"emotion": "triunfo", "allowed_intentions": ["revelar", "celebrar", "afirmar"], "prohibited_tone": ["hesitante", "neutro"]}
        ]
      }
    }
  },
  
  "properties": {
    "id": {
      "type": "integer",
      "minimum": 1,
      "description": "Identificador único da palavra"
    },
    
    "palavra": {
      "type": "string",
      "description": "Termo linguístico sendo analisado",
      "examples": ["amizade", "correr", "alegria"]
    },
    
    "definicao": {
      "type": "string",
      "description": "Significado semântico do termo",
      "examples": [
        "Relação de afeto, carinho e respeito entre pessoas.",
        "Ato de mover-se rapidamente com os pés.",
        "Sentimento de prazer e satisfação."
      ]
    },
    
    "uso_comunicativo": {
      "type": "object",
      "description": "Função primária no discurso com evidências robustecidas",
      "properties": {
        "categoria_primaria": {
          "type": "string",
          "enum": ["informacao", "interacao", "emocao", "diretivo", "estrutural", "outro"],
          "description": "Categoria principal do uso comunicativo",
          "examples": ["informacao", "emocao"]
        },
        "subcategoria": {
          "type": "string",
          "description": "Subcategoria detalhada do uso comunicativo",
          "$comment": "Valores dinâmicos gerenciados por dynamic_enum"
        },
        "evidencias": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "type": {
                "type": "string",
                "enum": ["morfologia", "sintaxe", "pragmatica", "fonologia", "semântica", "lógica", "corpus", "especialista"]
              },
              "reference": {"type": "string"},
              "confidence": {
                "type": "number",
                "minimum": 0,
                "maximum": 1
              }
            },
            "required": ["type", "confidence"]
          },
          "minItems": 1,
          "description": "Evidências linguísticas que suportam a classificação"
        }
      },
      "required": ["categoria_primaria", "subcategoria", "evidencias"]
    },
    
    "semantic_inheritance": {
      "type": ["object", "null"],
      "description": "Herança de propriedades semânticas de termos relacionados",
      "properties": {
        "parent_term": {
          "type": "string",
          "description": "Termo semântico relacionado"
        },
        "inherited_properties": {
          "type": "array",
          "items": {
            "enum": ["emotion", "intention", "tone", "context"]
          },
          "description": "Propriedades herdadas do termo relacionado"
        },
        "similarity_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Grau de similaridade semântica"
        },
        "inheritance_evidence": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Evidências que suportam a relação de herança"
        }
      }
    },
    
    "emotion": {
      "type": "object",
      "description": "Descrição da emoção associada ao termo",
      "properties": {
        "label": {
          "const": "#3_emocao"
        },
        "type": {
          "const": "categorical+intensity"
        },
        "allowed_values": {
          "type": "array",
          "items": {
            "oneOf": [
              {"type": "string"},
              {"$ref": "#/$defs/descriptive_value"}
            ]
          },
          "description": "Valores permitidos para emoção"
        },
        "value": {
          "type": "string",
          "description": "Valor atual da emoção, deve estar entre allowed_values"
        },
        "value_stats": {
          "$ref": "#/$defs/value_stats"
        },
        "contextual_weights": {
          "type": "object",
          "properties": {
            "formality_weight": {
              "type": "number",
              "minimum": 0.5,
              "maximum": 1.5,
              "default": 1.0,
              "description": "Peso da formalidade na intensidade emocional"
            }
          }
        }
      },
      "required": ["label", "type", "allowed_values", "value"]
    },
    
    "intention": {
      "type": "object",
      "description": "Intenção comunicativa do termo",
      "properties": {
        "label": {
          "const": "#1_intencao"
        },
        "type": {
          "const": "categorical"
        },
        "allowed_values": {
          "type": "array",
          "items": {
            "oneOf": [
              {"type": "string"},
              {"$ref": "#/$defs/descriptive_value"}
            ]
          },
          "description": "Valores permitidos para intenção"
        },
        "value": {
          "type": "string",
          "description": "Valor atual da intenção, deve estar entre allowed_values"
        },
        "value_stats": {
          "$ref": "#/$defs/value_stats"
        }
      },
      "required": ["label", "type", "allowed_values", "value"]
    },
    
    "tone": {
      "type": "object",
      "description": "Tom utilizado na comunicação",
      "properties": {
        "label": {
          "const": "#2_tom"
        },
        "type": {
          "const": "categorical"
        },
        "allowed_values": {
          "type": "array",
          "items": {
            "oneOf": [
              {"type": "string"},
              {"$ref": "#/$defs/descriptive_value"}
            ]
          },
          "description": "Valores permitidos para tom"
        },
        "value": {
          "type": "string",
          "description": "Valor atual do tom, deve estar entre allowed_values"
        },
        "value_stats": {
          "$ref": "#/$defs/value_stats"
        },
        "contextual_weights": {
          "type": "object",
          "properties": {
            "discourse_weight": {
              "type": "number",
              "minimum": 0.5,
              "maximum": 1.5,
              "default": 1.0,
              "description": "Peso do tipo de discurso na determinação do tom"
            }
          }
        }
      },
      "required": ["label", "type", "allowed_values", "value"]
    },
    
    "intensity": {
      "type": "object",
      "description": "Intensidade da propriedade semântica com calibração contextual",
      "properties": {
        "label": {
          "const": "#5_intensidade"
        },
        "type": {
          "const": "numeric"
        },
        "value": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Valor numérico da intensidade"
        },
        "calibration": {
          "type": "object",
          "description": "Modificadores contextuais para calibrar a intensidade",
          "properties": {
            "context_modifiers": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "context_type": {
                    "type": "string",
                    "description": "Tipo de contexto que modifica a intensidade"
                  },
                  "modifier": {
                    "type": "number",
                    "description": "Fator de modificação aplicado"
                  },
                  "evidence": {
                    "type": "string",
                    "description": "Fonte da modificação contextual"
                  }
                },
                "required": ["context_type", "modifier"]
              }
            }
          }
        },
        "contextual_weights": {
          "type": "object",
          "properties": {
            "emotion_weight": {
              "type": "number",
              "minimum": 0.5,
              "maximum": 1.5,
              "default": 1.0
            },
            "context_weight": {
              "type": "number",
              "minimum": 0.5,
              "maximum": 1.5,
              "default": 1.0
            }
          }
        }
      },
      "required": ["label", "type", "value"]
    },
    
    "context": {
      "type": "object",
      "description": "Contexto comunicativo do termo com validação expandida",
      "properties": {
        "discourse_type": {
          "type": "string",
          "enum": [
            "narrativo",
            "dialogal",
            "argumentativo",
            "descritivo",
            "instrução",
            "expositivo",
            "poético",
            "jurídico",
            "técnico",
            "formal",
            "pessoal",
            "profissional",
            "social",
            "artístico",
            "acadêmico",
            "expressivo",
            "retórico",
            "filosófico",
            "religioso",
            "literário",
            "analítico",
            "administrativo",
            "epistolar",
            "aconselhamento"
          ],
          "description": "Tipo de discurso",
          "examples": ["dialogal", "instrução", "formal"]
        },
        "formality_level": {
          "type": "integer",
          "minimum": 1,
          "maximum": 5,
          "description": "Nível de formalidade (1=informal, 5=formal)",
          "examples": [1, 3, 5]
        },
        "speaker_role": {
          "type": "string",
          "enum": ["emissor", "receptor", "ambos"],
          "description": "Papel do falante",
          "examples": ["emissor"]
        },
        "temporal_scope": {
          "type": "string",
          "enum": ["passado", "presente", "futuro", "hipotético"],
          "description": "Escopo temporal da comunicação",
          "examples": ["presente"]
        },
        "modality": {
          "type": "string",
          "enum": ["afirmativo", "negativo", "possibilidade", "desejo"],
          "description": "Modalidade do enunciado",
          "examples": ["afirmativo"]
        },
        "domain_specific": {
          "type": "object",
          "properties": {
            "domain": {
              "type": "string",
              "description": "Domínio específico de uso"
            },
            "constraints": {
              "type": "array",
              "items": {"type": "string"},
              "description": "Restrições específicas do domínio"
            }
          }
        }
      },
      "required": ["discourse_type", "formality_level"]
    },
    
    "curation_info": {
      "$ref": "#/$defs/curation_info",
      "description": "Informações de curadoria e validação manual"
    },
    
    "dynamic_enums": {
      "type": "object",
      "properties": {
        "uso_comunicativo_subcategorias": {
          "$ref": "#/$defs/dynamic_enum",
          "default": {
            "base_values": [
              "saudar", "despedir", "perguntar", "responder", "expressar_alegria", 
              "expressar_raiva", "ordenar", "pedir_ajuda"
            ],
            "extensible": true,
            "new_values_log": []
          },
          "description": "Enum dinâmico para subcategorias de uso comunicativo"
        },
        "discourse_types": {
          "$ref": "#/$defs/dynamic_enum",
          "default": {
            "base_values": [
              "narrativo", "dialogal", "argumentativo", "descritivo",
              "instrução", "expositivo", "poético", "jurídico", "técnico"
            ],
            "extensible": true,
            "new_values_log": []
          }
        }
      }
    },
    
    "compatibility_matrix": {
      "$ref": "#/$defs/compatibility_matrix",
      "description": "Matriz de compatibilidade entre propriedades semânticas"
    },
    
    "entity_linking": {
      "type": "object",
      "description": "Ligação a bases de conhecimento estruturadas",
      "properties": {
        "wikidata_id": {"type": "string"},
        "dbpedia_uri": {"type": "string"},
        "domain_specific_ids": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "source": {"type": "string"},
              "id": {"type": "string"}
            }
          }
        }
      }
    },
    
    "last_modified": {
      "type": "string",
      "format": "date-time",
      "description": "Data da última modificação do registro"
    }
  },
  
  "required": [
    "id",
    "palavra",
    "definicao",
    "uso_comunicativo",
    "emotion",
    "intention",
    "tone",
    "intensity",
    "context",
    "compatibility_matrix"
  ],
  
  "x-adaptive-rules": [
    {
      "field": "uso_comunicativo.subcategoria",
      "on_new_value": {
        "action": "log",
        "target": "dynamic_enums.uso_comunicativo_subcategorias.new_values_log",
        "require_evidence": true
      },
      "on_threshold": {
        "threshold": 10,
        "action": "add_to_base_values"
      }
    },
    {
      "field": "context.discourse_type",
      "on_new_value": {
        "action": "log",
        "target": "dynamic_enums.discourse_types.new_values_log",
        "require_evidence": true
      },
      "on_threshold": {
        "threshold": 5,
        "action": "add_to_base_values"
      }
    }
  ],
  
  "x-domain-rules": [
    {
      "domain": "técnico",
      "rules": [
        {
          "emotion.value": {"enum": ["neutralidade", "rigor", "eficiência", "controle"]},
          "message": "Domínio técnico requer emoções específicas"
        },
        {
          "tone.value": {"not": ["humorístico", "coloquial"]},
          "message": "Tom inadequado para contexto técnico"
        }
      ]
    },
    {
      "domain": "literário",
      "rules": [
        {
          "tone.value": {"not": ["neutro", "técnico"]},
          "message": "Domínio literário requer tom expressivo"
        },
        {
          "intensity.value": {"minimum": 0.3},
          "message": "Intensidade mínima esperada em contexto literário"
        }
      ]
    },
    {
      "domain": "jurídico",
      "rules": [
        {
          "formality_level": {"minimum": 4},
          "message": "Contexto jurídico requer formalidade elevada"
        },
        {
          "tone.value": {"enum": ["erudito", "solene", "preciso", "neutro"]},
          "message": "Tom inadequado para contexto jurídico"
        }
      ]
    }
  ],
  
  "external_sources": [
    {
      "name": "Dicionário Aberto",
      "description": "Definições em português, aberto, sem autenticação.",
      "url": "https://api.dicionario-aberto.net/word/{palavra}"
    },
    {
      "name": "Wikidata API",
      "description": "Conhecimento estruturado multilíngue",
      "url": "https://www.wikidata.org/w/api.php?action=wbsearchentities&search={palavra}&language=pt&format=json"
    },
    {
      "name": "DBpedia",
      "description": "Dados estruturados da Wikipedia",
      "url": "http://pt.dbpedia.org/data/{palavra}.json"
    },
    {
      "name": "OwlBot API",
      "description": "API multilíngue, inclui português",
      "url": "https://owlbot.info/api/v4/dictionary/{palavra}"
    }
  ],
  
  "dependencies": {
    "context.discourse_type": {
      "oneOf": [
        {
          "properties": {
            "context.discourse_type": {"enum": ["técnico", "jurídico", "acadêmico"]}
          },
          "required": ["value_stats"]
        }
      ]
    }
  }
}